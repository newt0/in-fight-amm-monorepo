# LMSR 预测市场实现文档

## 📊 LMSR (Logarithmic Market Scoring Rule) 概述

LMSR 是预测市场中最流行的自动做市商（AMM）机制之一，由 Robin Hanson 提出。它能够保证市场的流动性，并且具有良好的数学性质。

## 🧮 核心数学公式

### 1. 成本函数 (Cost Function)
```
C(q) = b × ln(Σ e^(qi/b))
```
- `b`: 流动性参数（liquidity parameter），控制市场深度
- `qi`: 结果 i 的流通股份数量
- `C(q)`: 当前市场状态的总成本

### 2. 价格函数 (Price Function)
```
pi = e^(qi/b) / Σ(e^(qj/b))
```
- `pi`: 结果 i 的当前价格（0-1 之间）
- 所有价格之和 = 1（概率分布）

### 3. 买入成本 (Buy Cost)
```
买入 n 股结果 i 的成本 = C(q') - C(q)
其中 q' 是买入后的新状态：q'i = qi + n
```

### 4. 卖出收益 (Sell Revenue)
```
卖出 n 股结果 i 的收益 = C(q) - C(q')
其中 q' 是卖出后的新状态：q'i = qi - n
```

## 💡 LMSR 的优势

1. **自动定价**：价格根据供需自动调整
2. **保证流动性**：做市商始终愿意交易
3. **有界损失**：做市商的最大损失是可预测的（b × ln(n)，n 为结果数量）
4. **激励真实信息**：交易者提供真实信息可以盈利
5. **价格反映概率**：市场价格可以解释为预测概率

## 🔧 实现细节

### 流动性参数 b
- **当前设置**: `b = 100`
- **含义**: 控制价格对交易的敏感度
- **影响**:
  - b 越大 → 流动性越好，价格变化越平缓
  - b 越小 → 价格对交易反应越剧烈

### 初始状态
- Fighter A: 100 股份
- Fighter B: 100 股份
- 初始价格: 各 50%（0.50）

### 价格缩放
- LMSR 输出: 0-1 之间的概率
- 显示价格: 乘以 100 转换为 USDC 单位
- 例如: 0.50 → 50 USDC/票

### 成本计算示例

假设当前状态：
- qA = 100, qB = 100
- b = 100

**买入 5 股 Fighter A**:
```javascript
初始成本: C([100, 100]) = 100 × ln(e^1 + e^1) = 100 × ln(2×e) ≈ 169.31
新成本: C([105, 100]) = 100 × ln(e^1.05 + e^1) ≈ 174.29
买入成本: 174.29 - 169.31 = 4.98
显示价格: 4.98 × 100 = 498 USDC
```

## 📈 市场动态

### 价格变化机制
1. **买入** → 增加股份数量 → 提高该结果的价格
2. **卖出** → 减少股份数量 → 降低该结果的价格
3. **价格总和** = 100（始终）

### 市场平衡
- 初始：50% vs 50%
- 大量买入 A → A 价格上升（如 70%），B 价格下降（30%）
- 价格反映市场对比赛结果的集体预测

## 🎮 用户交互流程

### 买入流程
1. 用户选择买入数量（如 5 张票）
2. 系统计算 LMSR 成本：`buyCost([qA, qB], index, 5)`
3. 检查用户余额是否足够
4. 扣除余额，增加持仓
5. 更新市场股份数量：`qA += 5`
6. 价格自动根据新股份数量重新计算

### 卖出流程
1. 用户选择卖出数量（如 3 张票）
2. 系统计算 LMSR 收益：`sellRevenue([qA, qB], index, 3)`
3. 检查用户持仓是否足够
4. 增加余额，减少持仓
5. 更新市场股份数量：`qA -= 3`
6. 价格自动根据新股份数量重新计算

## 🤖 模拟交易

每秒自动执行的模拟交易：
- 随机选择 Fighter A 或 B（50% 概率）
- 随机决定买入或卖出（65% 买入，35% 卖出）
- 随机数量：1-3 股份
- 完全遵循 LMSR 定价规则

### 影响
- ✅ 改变市场股份数量
- ✅ 影响价格走势
- ✅ 影响奖池总额
- ❌ 不影响用户持仓
- ❌ 不显示在用户订单历史

## 📊 与简单定价模型的对比

| 特性 | 简单模型 | LMSR |
|------|---------|------|
| 价格计算 | 固定百分比影响 | 指数函数 |
| 流动性 | 手动设置 | 自动保证 |
| 价格范围 | 无限制 | 0-1（概率） |
| 市场深度 | 固定 | 可调节（b 参数） |
| 套利保护 | 无 | 有 |
| 数学基础 | 简单 | 严格 |

## 🎯 实际效果

### 价格响应性
- **小额交易**：价格变化温和
- **大额交易**：价格变化明显但不会失控
- **连续交易**：价格平滑调整

### 套利机会
如果市场价格偏离"真实概率"，理性交易者会：
1. 识别被低估的结果
2. 买入低估的票据
3. 推动价格回归合理水平

### 预测准确性
经过大量交易后，市场价格会收敛到：
- 集体智慧的预测
- 最接近真实胜率的估计

## 🔍 技术实现

### LMSR 类
```typescript
class LMSR {
  b: number // 流动性参数
  
  cost(quantities: number[]): number
  price(quantities: number[], index: number): number
  prices(quantities: number[]): number[]
  buyCost(quantities: number[], index: number, amount: number): number
  sellRevenue(quantities: number[], index: number, amount: number): number
}
```

### 状态管理
- `quantityA`, `quantityB`: 市场股份数量（LMSR 的核心状态）
- 价格通过 `useEffect` 实时计算
- 每次交易更新股份数量 → 自动触发价格更新

## 📚 参考资料

1. **原始论文**: "Logarithmic Market Scoring Rules for Modular Combinatorial Information Aggregation" - Robin Hanson
2. **应用案例**: 
   - Augur（区块链预测市场）
   - Gnosis（去中心化预测平台）
   - PredictIt（政治预测市场）
3. **在线计算器**: [LMSR Calculator](https://www.casualcryptograph.com/lmsr)

## 🚀 未来优化方向

1. **动态 b 值**：根据市场活跃度调整流动性
2. **多结果支持**：扩展到 3 个或更多结果
3. **组合市场**：支持复杂的条件预测
4. **链上实现**：将 LMSR 部署到 Sui 区块链
5. **手续费机制**：为平台可持续性添加小额手续费

## ✅ 当前实现特点

- ✅ 完整的 LMSR 数学模型
- ✅ 实时价格计算
- ✅ 准确的成本/收益计算
- ✅ 市场深度控制
- ✅ 自动化做市
- ✅ 用户友好的 UI
- ✅ 每秒模拟交易
- ✅ 完整的交易历史

---

**版本**: 1.0  
**最后更新**: 2025-11-19  
**实现语言**: TypeScript/React

